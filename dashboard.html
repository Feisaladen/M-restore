<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard â€” M-Restore</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='16'>ðŸŒ¿</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/supabase.min.js"></script>
    <script src="supabase.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              earth: {
                50: '#faf5f1',
                100: '#f0e6d8',
                200: '#e5d5bb',
                300: '#d4b995',
                400: '#c4a077',
                500: '#ab835b',
                600: '#8e6846',
                700: '#735338',
                800: '#5f442f',
                900: '#4f392a',
              },
              leaf: {
                50: '#f4f9f0',
                100: '#e5f1dd',
                200: '#cce3bf',
                300: '#a9ce95',
                400: '#85b66c',
                500: '#659a4b',
                600: '#4d7b37',
                700: '#3f612e',
                800: '#364f28',
                900: '#2e4223',
              }
            },
            keyframes: {
              'leaf-sway': {
                '0%, 100%': { transform: 'rotate(-3deg)' },
                '50%': { transform: 'rotate(3deg)' }
              }
            },
            animation: {
              'leaf-sway': 'leaf-sway 3s ease-in-out infinite'
            }
          }
        }
      }
    </script>
    <style>
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }
      .hero-pattern {
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M54.627 0l.83.828-1.415 1.415L51.8 0h2.827zM5.373 0l-.83.828L5.96 2.243 8.2 0H5.374zM48.97 0l3.657 3.657-1.414 1.414L46.143 0h2.828zM11.03 0L7.372 3.657 8.787 5.07 13.857 0H11.03zm32.284 0L49.8 6.485 48.384 7.9l-7.9-7.9h2.83zM16.686 0L10.2 6.485 11.616 7.9l7.9-7.9h-2.83zm20.97 0l9.315 9.314-1.414 1.414L34.828 0h2.83zM22.344 0L13.03 9.314l1.414 1.414L25.172 0h-2.83zM32 0l12.142 12.142-1.414 1.414L30 .828 17.272 13.556l-1.414-1.414L28 0h4zM.284 0l28 28-1.414 1.414L0 2.544V0h.284zM0 5.373l25.456 25.455-1.414 1.415L0 8.2V5.374zm0 5.656l22.627 22.627-1.414 1.414L0 13.86v-2.83zm0 5.656l19.8 19.8-1.415 1.413L0 19.514v-2.83zm0 5.657l16.97 16.97-1.414 1.415L0 25.172v-2.83zM0 28l14.142 14.142-1.414 1.414L0 30.828V28zm0 5.657L11.314 44.97 9.9 46.386l-9.9-9.9v-2.828zm0 5.657L8.485 47.8 7.07 49.212 0 42.143v-2.83zm0 5.657l5.657 5.657-1.414 1.415L0 47.8v-2.83zm0 5.657l2.828 2.83-1.414 1.413L0 53.456v-2.83zM54.627 60L30 35.373 5.373 60H8.2L30 38.2 51.8 60h2.827zm-5.656 0L30 41.03 11.03 60h2.828L30 43.858 46.142 60h2.83zm-5.656 0L30 46.686 16.686 60h2.83L30 49.515 40.485 60h2.83zm-5.657 0L30 52.343 22.344 60h2.83L30 55.172 34.828 60h2.83zM32 60l-2-2-2 2h4z' fill='%23065f46' fill-opacity='0.04' fill-rule='evenodd'/%3E%3C/svg%3E");
      }
      .glass-card {
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-b from-leaf-50 via-leaf-50 to-earth-50 hero-pattern">
    <!-- Header -->
    <header class="fixed top-0 inset-x-0 bg-white/80 backdrop-blur-lg border-b border-leaf-100 z-10">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <!-- Logo -->
          <div class="flex items-center gap-2">
            <span class="text-2xl animate-leaf-sway origin-bottom">ðŸŒ¿</span>
            <h1 class="text-xl font-bold bg-gradient-to-r from-leaf-800 to-earth-700 bg-clip-text text-transparent">
              M-Restore
            </h1>
          </div>
          
          <!-- Navigation -->
          <nav class="flex items-center gap-6">
            <a href="upload.html" class="text-earth-600 hover:text-leaf-700 font-medium">Upload</a>
            <button id="logout" class="px-4 py-2 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition-colors">
              Log out
            </button>
          </nav>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="pt-24 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
      <!-- Welcome Message -->
      <div class="text-center mb-12">
        <h2 class="text-2xl font-bold text-earth-800 mb-2">Your Land Analysis Dashboard</h2>
        <p class="text-earth-600">Track your soil health journey and restoration progress</p>
      </div>

      <!-- Grid of Analysis Cards -->
      <div id="grid" class="grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
        <!-- Cards will be inserted here by JavaScript -->
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="hidden text-center py-12">
        <div class="inline-block p-4 rounded-full bg-leaf-50 mb-4">
          <span class="text-4xl">ðŸŒ±</span>
        </div>
        <h3 class="text-xl font-medium text-earth-800 mb-2">No analyses yet</h3>
        <p class="text-earth-600 mb-6">Upload your first ground image to start your restoration journey</p>
        <a href="upload.html" 
           class="inline-block px-6 py-3 rounded-lg bg-leaf-600 text-white hover:bg-leaf-700 transition-colors">
          Upload First Image
        </a>
      </div>
    </main>

    <script>
      // Wait for Supabase to be ready before initializing dashboard functionality
      async function initDashboard() {
        // Wait for supabase to be initialized
        while (!window.supabase) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        console.log('âœ… Supabase ready, initializing dashboard...');

        // Protect page
        supabase.auth.getSession().then(({ data }) => {
          const session = data.session;
          if (!session) {
            window.location = 'login.html';
          } else {
            loadUserImages();
            showLatestAnalysis();
          }
        });

        document.getElementById('logout').addEventListener('click', async () => {
          await supabase.auth.signOut();
          window.location = 'login.html';
        });
      }

      // Initialize when DOM is ready
      document.addEventListener('DOMContentLoaded', initDashboard);

      // Show latest analysis results from sessionStorage
      function showLatestAnalysis() {
        const latestAnalysis = sessionStorage.getItem('latestAnalysis');
        if (latestAnalysis) {
          try {
            const analysis = JSON.parse(latestAnalysis);
            displayAnalysisResults(analysis);
            // Clear the stored analysis after displaying
            sessionStorage.removeItem('latestAnalysis');
          } catch (error) {
            console.error('Error parsing analysis results:', error);
          }
        }
      }

      // Display analysis results on the dashboard
      function displayAnalysisResults(analysis) {
        const grid = document.getElementById('grid');
        const emptyState = document.getElementById('empty-state');
        
        if (grid && emptyState) {
          grid.classList.remove('hidden');
          emptyState.classList.add('hidden');
          
          const analysisCard = createAnalysisResultCard(analysis);
          grid.innerHTML = analysisCard;
        }
      }

      // Create a card to display analysis results
      function createAnalysisResultCard(analysis) {
        const soilAnalysis = analysis.soil_analysis || {};
        const detectedObjects = analysis.detected_objects || [];
        
        return `
          <div class="bg-white/70 glass-card rounded-xl shadow-md overflow-hidden border border-leaf-100 hover:shadow-lg transition-shadow fade-in">
            <div class="aspect-w-16 aspect-h-9 bg-leaf-50 p-4">
              <div class="text-center">
                <span class="text-6xl mb-4 inline-block">ðŸ¤–</span>
                <h3 class="text-xl font-semibold text-earth-800 mb-2">AI Soil Analysis Complete</h3>
                <p class="text-sm text-earth-600">Powered by Google Gemini AI</p>
              </div>
            </div>
            
            <div class="p-6">
              <!-- Status Badge -->
              <div class="flex items-center justify-between mb-4">
                <span class="px-3 py-1 rounded-full text-sm bg-green-50 text-green-700 border border-green-200">
                  âœ“ Analysis Complete
                </span>
                <span class="text-sm text-earth-500">${new Date().toLocaleDateString()}</span>
              </div>

              <!-- Analysis Results -->
              <div class="space-y-4">
                <div>
                  <h3 class="font-semibold text-earth-800 mb-2">${soilAnalysis.issue || 'Soil Analysis'}</h3>
                  <p class="text-sm text-earth-600 mb-4">${soilAnalysis.explanation || 'Analysis completed successfully'}</p>
                </div>
                
                <div class="space-y-3">
                  <!-- Recommendations -->
                  ${soilAnalysis.recommendations && soilAnalysis.recommendations.length > 0 ? `
                    <div class="bg-leaf-50/50 rounded-lg p-3">
                      <h4 class="text-sm font-medium text-earth-700 mb-1">Recommendations</h4>
                      <ul class="text-sm text-earth-600 space-y-1">
                        ${soilAnalysis.recommendations.map(rec => `<li>â€¢ ${rec}</li>`).join('')}
                      </ul>
                    </div>
                  ` : ''}
                  
                  <!-- Suggested Crops -->
                  ${soilAnalysis.suggested_crops && soilAnalysis.suggested_crops.length > 0 ? `
                    <div class="bg-earth-50/50 rounded-lg p-3">
                      <h4 class="text-sm font-medium text-earth-700 mb-1">Suggested Crops</h4>
                      <p class="text-sm text-earth-600">
                        ${soilAnalysis.suggested_crops.join(', ')}
                      </p>
                    </div>
                  ` : ''}

                  <!-- Detected Objects -->
                  ${detectedObjects.length > 0 ? `
                    <div class="bg-blue-50/50 rounded-lg p-3">
                      <h4 class="text-sm font-medium text-earth-700 mb-1">Detected Objects</h4>
                      <p class="text-sm text-earth-600">
                        ${detectedObjects.map(obj => obj.label || obj).join(', ')}
                      </p>
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      }

      async function loadUserImages() {
        const user = (await supabase.auth.getUser()).data.user;
        if (!user) { window.location = 'login.html'; return; }

        const { data: images, error } = await supabase
          .from('land_images')
          .select('*')
          .eq('user_id', user.id)
          .order('uploaded_at', { ascending: false });

        if (error) { 
          console.error(error); 
          return; 
        }

        const grid = document.getElementById('grid');
        const emptyState = document.getElementById('empty-state');

        if (!images || images.length === 0) {
          grid.classList.add('hidden');
          emptyState.classList.remove('hidden');
          return;
        }

        grid.classList.remove('hidden');
        emptyState.classList.add('hidden');
        grid.innerHTML = '';

        for (const img of images) {
          // Fetch analysis (maybeSingle avoids error if none)
          const { data: analysis } = await supabase
            .from('analysis_results')
            .select('*')
            .eq('image_id', img.id)
            .maybeSingle();

          const uploadDate = new Date(img.uploaded_at).toLocaleDateString();
          const cardHtml = createAnalysisCard(img, analysis, uploadDate);
          
          const cardDiv = document.createElement('div');
          cardDiv.className = 'fade-in';
          cardDiv.style.animationDelay = '${index * 100}ms';
          cardDiv.innerHTML = cardHtml;
          grid.appendChild(cardDiv);
        }
      }

      function createAnalysisCard(img, analysis, date) {
        const status = analysis ? 'complete' : 'pending';
        const statusColors = {
          complete: 'bg-green-50 text-green-700 border-green-200',
          pending: 'bg-yellow-50 text-yellow-700 border-yellow-200'
        };
        
        return `
          <div class="bg-white/70 glass-card rounded-xl shadow-md overflow-hidden border border-leaf-100 hover:shadow-lg transition-shadow">
            <div class="aspect-w-16 aspect-h-9 bg-leaf-50">
              <img src="${img.image_url}" class="w-full h-48 object-cover" alt="Ground image" />
            </div>
            
            <div class="p-6">
              <!-- Status Badge -->
              <div class="flex items-center justify-between mb-4">
                <span class="px-3 py-1 rounded-full text-sm ${statusColors[status]} border">
                  ${status === 'complete' ? 'âœ“ Analyzed' : 'â‹¯ Processing'}
                </span>
                <span class="text-sm text-earth-500">${date}</span>
              </div>

              ${analysis ? `
                <!-- Analysis Results -->
                <h3 class="font-semibold text-earth-800 mb-2">${analysis.issue}</h3>
                <p class="text-sm text-earth-600 mb-4 line-clamp-2">${analysis.explanation}</p>
                
                <div class="space-y-3">
                  <!-- Recommendations -->
                  <div class="bg-leaf-50/50 rounded-lg p-3">
                    <h4 class="text-sm font-medium text-earth-700 mb-1">Recommendations</h4>
                    <p class="text-sm text-earth-600 line-clamp-3">${analysis.recommendations}</p>
                  </div>
                  
                  <!-- Suggested Crops -->
                  <div class="bg-earth-50/50 rounded-lg p-3">
                    <h4 class="text-sm font-medium text-earth-700 mb-1">Suggested Crops</h4>
                    <p class="text-sm text-earth-600">
                      ${Array.isArray(analysis.suggested_crops) 
                        ? analysis.suggested_crops.join(', ') 
                        : analysis.suggested_crops}
                    </p>
                  </div>
                </div>
              ` : `
                <!-- Pending Analysis -->
                <div class="text-center py-4">
                  <div class="animate-pulse">
                    <div class="h-4 bg-leaf-100 rounded w-3/4 mx-auto mb-3"></div>
                    <div class="h-3 bg-leaf-100 rounded w-1/2 mx-auto"></div>
                  </div>
                </div>
              `}
            </div>
          </div>
        `;
      }
    </script>
  </body>
</html>