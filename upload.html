<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Upload ‚Äî M-Restore</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <script src="supabase.js"></script> <!-- This should initialize Supabase client -->
</head>
<body class="min-h-screen bg-gradient-to-br from-green-50 via-white to-green-100 flex items-center justify-center p-6">
  <div class="w-full max-w-xl bg-white/90 backdrop-blur rounded-2xl shadow-lg p-8 border border-green-100">
    <div class="text-center mb-6">
      <h1 class="text-3xl font-bold text-green-700">üå± Upload Image</h1>
      <p class="text-sm text-gray-600 mt-1">Submit a land photo to get an instant AI analysis.</p>
    </div>

    <form id="upload-form" class="space-y-6" onsubmit="return false;">
      <!-- Image input -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Select Image</label>
        <label for="file" class="flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-green-300 rounded-lg cursor-pointer bg-green-50/30 hover:bg-green-100 transition">
          <div class="flex flex-col items-center justify-center pt-5 pb-6 text-center">
            <svg class="w-10 h-10 text-green-600 mb-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16l4-4 4 4m0 0l4-4 4 4M4 20h16" />
            </svg>
            <p class="text-sm text-gray-600"><span class="font-semibold text-green-700">Click to upload</span> or drag & drop</p>
            <p class="text-xs text-gray-400 mt-1">PNG, JPG, JPEG (max 5MB)</p>
          </div>
          <input id="file" type="file" accept="image/*" class="hidden" required />
        </label>
      </div>

      <!-- Preview -->
      <div id="preview" class="hidden border rounded-lg p-2 bg-gray-50">
        <img id="preview-img" src="" alt="Preview" class="w-full h-auto rounded-md" />
      </div>

      <!-- Location -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Location (optional)</label>
        <div class="flex gap-2">
          <input id="lat" type="text" placeholder="Latitude" class="w-1/2 rounded-md border-gray-200 shadow-sm focus:ring-green-500 focus:border-green-500" />
          <input id="lon" type="text" placeholder="Longitude" class="w-1/2 rounded-md border-gray-200 shadow-sm focus:ring-green-500 focus:border-green-500" />
        </div>
        <button id="use-geo" class="mt-2 text-sm text-green-700 hover:underline">üìç Use my location</button>
      </div>

      <!-- Message / status -->
      <div id="message" class="text-sm text-gray-700 min-h-[1.5em] text-center"></div>

      <!-- Buttons -->
      <div class="flex items-center justify-between">
        <a href="dashboard.html" class="text-sm text-gray-600 hover:underline">‚Üê Back to Dashboard</a>
        <button id="upload-btn" class="px-5 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md font-semibold shadow transition">
          Upload & Analyze
        </button>
      </div>
    </form>
  </div>

  <script>
    async function initUpload() {
      while (!window.supabase) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      console.log('‚úÖ Supabase ready, initializing upload...');

      const fileInput = document.getElementById('file');
      const previewDiv = document.getElementById('preview');
      const previewImg = document.getElementById('preview-img');
      const msg = document.getElementById('message');
      const uploadBtn = document.getElementById('upload-btn');
      const useGeo = document.getElementById('use-geo');

      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (file) {
          previewImg.src = URL.createObjectURL(file);
          previewDiv.classList.remove('hidden');
        }
      });

      useGeo.addEventListener('click', async (e) => {
        e.preventDefault();
        msg.textContent = 'Fetching location...';
        if (!navigator.geolocation) return msg.textContent = 'Geolocation not supported.';
        navigator.geolocation.getCurrentPosition(
          pos => {
            document.getElementById('lat').value = pos.coords.latitude.toFixed(6);
            document.getElementById('lon').value = pos.coords.longitude.toFixed(6);
            msg.textContent = 'Location added ‚úÖ';
          },
          err => msg.textContent = 'Error: ' + err.message,
          { timeout: 10000 }
        );
      });

      uploadBtn.addEventListener('click', async () => {
        msg.textContent = '';
        uploadBtn.disabled = true;
        uploadBtn.classList.add('opacity-50');

        try {
          const { data: userData } = await supabase.auth.getUser();
          const user = userData?.user;
          if (!user) {
            msg.textContent = 'Please log in first.';
            setTimeout(() => (window.location = 'login.html'), 1000);
            return;
          }

          const file = fileInput.files[0];
          if (!file) throw new Error('Select a file first.');

          const formData = new FormData();
          formData.append('image', file);
          formData.append('userId', user.id);
          formData.append('lat', document.getElementById('lat').value || '');
          formData.append('lon', document.getElementById('lon').value || '');

          msg.textContent = 'ü§ñ Analyzing image... please wait (this may take 30-60 seconds)';

          const res = await fetch('http://localhost:3000/api/analyze', {
            method: 'POST',
            body: formData,
          });

          const analysisData = await res.json();

          if (!res.ok || !analysisData.success) {
            console.error('Analysis API Error:', analysisData);
            throw new Error(analysisData.error || `Analysis failed`);
          }

          console.log('Analysis successful:', analysisData);
          msg.textContent = '‚úÖ Analysis complete!';

          if (analysisData.analysis && analysisData.analysis.soil_analysis) {
            const soilAnalysis = analysisData.analysis.soil_analysis;
            msg.textContent += `\n\nüîç ${soilAnalysis.issue}`;
            msg.textContent += `\nüí° ${soilAnalysis.recommendations[0] || 'Check dashboard for more'}`;
          }

          sessionStorage.setItem('latestAnalysis', JSON.stringify(analysisData.analysis));
          setTimeout(() => (window.location = 'dashboard.html'), 3000);
        } catch (err) {
          console.error(err);
          msg.textContent = '‚ùå ' + (err.message || 'Upload failed');
        } finally {
          uploadBtn.disabled = false;
          uploadBtn.classList.remove('opacity-50');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', initUpload);
  </script>
</body>
</html>
