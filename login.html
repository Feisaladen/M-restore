<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login — M-Restore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/supabase.min.js"></script>
    <script src="supabase.js"></script>
  </head>
  <body class="min-h-screen bg-gray-50 flex items-center justify-center">
    <div class="w-full max-w-md p-8 bg-white rounded-lg shadow">
      <h2 class="text-2xl font-bold text-gray-800">Log In</h2>
      <p class="text-sm text-gray-500 mt-1">Welcome back — please enter your credentials.</p>

      <form id="login-form" class="mt-6 space-y-4" onsubmit="return false;">
        <div>
          <label class="block text-sm font-medium text-gray-700">Email</label>
          <input id="email" type="email" required class="mt-1 block w-full rounded-md border-gray-200 shadow-sm" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Password</label>
          <input id="password" type="password" required class="mt-1 block w-full rounded-md border-gray-200 shadow-sm" />
        </div>

        <div id="message" class="text-sm"></div>

        <button id="login-btn" class="w-full py-2 rounded-md bg-green-600 text-white font-semibold">Log In</button>
      </form>

      <p class="mt-4 text-sm text-gray-600">Don't have an account? <a href="signup.html" class="text-green-600 font-semibold">Sign up</a></p>

<script>
  // Wait for Supabase to be ready before initializing login functionality
  async function initLogin() {
    // Wait for supabase to be initialized
    while (!window.supabase) {
      await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    console.log('✅ Supabase ready, initializing login...');

    // ✅ Redirect to dashboard if user already has a session
    supabase.auth.getSession().then(({ data }) => {
      if (data.session) window.location = 'dashboard.html';
    });

    const form = document.getElementById('login-form');
    const msg = document.getElementById('message');
    const loginBtn = document.getElementById('login-btn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';
      msg.className = 'text-sm'; // Reset message styling
      
      const email = document.getElementById('email').value.trim().toLowerCase();
      const password = document.getElementById('password').value;

      // Basic validation
      if (!email || !password) {
        msg.textContent = 'Please fill in all fields.';
        msg.className = 'text-sm text-red-600';
        return;
      }

      // Email format validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        msg.textContent = 'Please enter a valid email address.';
        msg.className = 'text-sm text-red-600';
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing in...';

      try {
        console.log('Attempting login for:', email);
        const { data, error } = await supabase.auth.signInWithPassword({ 
          email, 
          password 
        });
        
        if (error) {
          console.error('Login error:', error);
          throw error;
        }
        
        console.log('Login successful:', data);
        msg.textContent = 'Login successful — redirecting...';
        msg.className = 'text-sm text-green-600';
        
        setTimeout(() => { 
          window.location = 'dashboard.html'; 
        }, 800);
      } catch (err) {
        console.error('Login failed:', err);
        let errorMessage = 'Login failed. Please try again.';
        
        if (err.message) {
          if (err.message.includes('Invalid login credentials')) {
            errorMessage = 'Invalid email or password.';
          } else if (err.message.includes('Email not confirmed')) {
            errorMessage = 'Please check your email and confirm your account.';
          } else {
            errorMessage = err.message;
          }
        }
        
        msg.textContent = errorMessage;
        msg.className = 'text-sm text-red-600';
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Log In';
      }
    });
  }

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', initLogin);
</script>
