<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sign Up — M-Restore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/supabase.min.js"></script>
    <script src="supabase.js"></script>
  </head>
  <body class="min-h-screen bg-gray-50 flex items-center justify-center">
    <div class="w-full max-w-md p-8 bg-white rounded-lg shadow">
      <h2 class="text-2xl font-bold text-gray-800">Create an account</h2>
      <p class="text-sm text-gray-500 mt-1">Sign up to start restoring land.</p>

      <form id="signup-form" class="mt-6 space-y-4" onsubmit="return false;">
        <div>
          <label class="block text-sm font-medium text-gray-700">Email</label>
          <input id="email" type="email" required class="mt-1 block w-full rounded-md border-gray-200 shadow-sm" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Password</label>
          <input id="password" type="password" required class="mt-1 block w-full rounded-md border-gray-200 shadow-sm" />
        </div>

        <div id="message" class="text-sm"></div>

        <button id="signup-btn" class="w-full py-2 rounded-md bg-green-600 text-white font-semibold">Sign Up</button>
      </form>

      <p class="mt-4 text-sm text-gray-600">Already have an account? <a href="login.html" class="text-green-600 font-semibold">Log in</a></p>

      <script>
        // Wait for Supabase to be ready before initializing signup functionality
        async function initSignup() {
          // Wait for supabase to be initialized
          while (!window.supabase) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }
          
          console.log('✅ Supabase ready, initializing signup...');

          // If user already has a session, go to upload
          supabase.auth.getSession().then(({ data }) => {
            if (data.session) window.location = 'upload.html';
          });

          const form = document.getElementById('signup-form');
          const msg = document.getElementById('message');
          const signupBtn = document.getElementById('signup-btn');
          
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            msg.textContent = '';
            msg.className = 'text-sm'; // Reset message styling
            
            const email = document.getElementById('email').value.trim().toLowerCase();
            const password = document.getElementById('password').value;

            // Basic validation
            if (!email || !password) {
              msg.textContent = 'Please fill in all fields.';
              msg.className = 'text-sm text-red-600';
              return;
            }

            // Email format validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
              msg.textContent = 'Please enter a valid email address.';
              msg.className = 'text-sm text-red-600';
              return;
            }

            // Password validation
            if (password.length < 6) {
              msg.textContent = 'Password must be at least 6 characters long.';
              msg.className = 'text-sm text-red-600';
              return;
            }

            signupBtn.disabled = true;
            signupBtn.textContent = 'Creating account...';

            try {
              console.log('Attempting signup for:', email);
              const { data, error } = await supabase.auth.signUp({ 
                email, 
                password 
              });
              
              if (error) {
                console.error('Signup error:', error);
                throw error;
              }
              
              console.log('Signup successful:', data);
              
              // Check if email confirmation is required
              if (data.user && !data.user.email_confirmed_at) {
                msg.textContent = 'Account created! Please check your email to confirm your account.';
                msg.className = 'text-sm text-green-600';
                // Don't redirect if email confirmation is required
                setTimeout(() => { 
                  window.location = 'login.html'; 
                }, 2000);
              } else {
                msg.textContent = 'Account created successfully — redirecting...';
                msg.className = 'text-sm text-green-600';
                setTimeout(() => { 
                  window.location = 'upload.html'; 
                }, 800);
              }
              
            } catch (err) {
              console.error('Signup failed:', err);
              let errorMessage = 'Signup failed. Please try again.';
              
              if (err.message) {
                if (err.message.includes('User already registered')) {
                  errorMessage = 'An account with this email already exists. Try logging in instead.';
                } else if (err.message.includes('Password should be at least')) {
                  errorMessage = 'Password is too weak. Please choose a stronger password.';
                } else if (err.message.includes('Invalid email')) {
                  errorMessage = 'Please enter a valid email address.';
                } else {
                  errorMessage = err.message;
                }
              }
              
              msg.textContent = errorMessage;
              msg.className = 'text-sm text-red-600';
            } finally {
              signupBtn.disabled = false;
              signupBtn.textContent = 'Sign Up';
            }
          });
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initSignup);
      </script>
    </div>
  </body>
</html>